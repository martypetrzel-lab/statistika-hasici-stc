name: Push RSS to Railway API

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *" # každých 5 minut

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - name: Push RSS to Railway API (robust)
        env:
          INGEST_API_URL: ${{ secrets.INGEST_API_URL }}
          RSS_URL: ${{ secrets.RSS_URL }}
        run: |
          set -euo pipefail

          if [ -z "${INGEST_API_URL:-}" ]; then
            echo "Missing secret INGEST_API_URL"
            exit 1
          fi

          if [ -z "${RSS_URL:-}" ]; then
            echo "Missing secret RSS_URL"
            exit 1
          fi

          echo "Testing API reachability..."
          curl -4 --show-error --fail --connect-timeout 20 --max-time 60 "$INGEST_API_URL/health" || true

          echo "Pushing ingest trigger..."
          # POZOR: endpoint je /api/ingest (ne /ingest)
          curl -4 --show-error --fail-with-body \
            --connect-timeout 20 \
            --max-time 120 \
            --retry 10 \
            --retry-all-errors \
            --retry-delay 5 \
            -H "Content-Type: application/json" \
            -X POST "$INGEST_API_URL/api/ingest" \
            --data "{\"feedUrl\":\"$RSS_URL\"}"

          echo "Done."
