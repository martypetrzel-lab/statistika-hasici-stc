name: RSS ingest (trigger)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  trigger:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger ingest on Railway (async)
        env:
          INGEST_API_URL: ${{ secrets.INGEST_API_URL }}
          RSS_URL: ${{ secrets.RSS_URL }}
        run: |
          set -euo pipefail

          echo "Testing API reachability..."
          curl --show-error --fail --connect-timeout 15 --max-time 30 "${INGEST_API_URL}/health"

          echo "Trigger ingest (async)..."
          curl --show-error --fail-with-body \
            --connect-timeout 15 \
            --max-time 30 \
            --retry 10 \
            --retry-all-errors \
            --retry-delay 5 \
            -H "Content-Type: application/json" \
            -X POST "${INGEST_API_URL}/api/ingest?async=1" \
            --data "{\"feedUrl\":\"${RSS_URL}\"}"

          echo "Done."
